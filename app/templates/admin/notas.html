{% extends "admin/base_admin.html" %}

{% block title %}Gestión de Notas - Sistema de Notas{% endblock %}

{% block admin_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-clipboard-list me-2"></i>Gestión de Notas</h2>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin.exportar_notas', ciclo_id=request.args.get('ciclo_id'), curso_id=request.args.get('curso_id'), estado=request.args.get('estado', 'todas')) }}" 
                   class="btn btn-outline-success">
                    <i class="fas fa-download me-2"></i>Exportar CSV
                </a>
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtros de Búsqueda -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h5>
            </div>
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="ciclo_id" class="form-label">Ciclo Académico:</label>
                        <select class="form-select" id="ciclo_id" name="ciclo_id">
                            <option value="">-- Todos los ciclos --</option>
                            {% for ciclo in ciclos %}
                            <option value="{{ ciclo.id }}" 
                                    {% if ciclo_seleccionado and ciclo.id == ciclo_seleccionado.id %}selected{% endif %}

<!-- Paginación -->
{% if notas_paginadas and notas_paginadas.pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Navegación de páginas">
            <ul class="pagination justify-content-center">
                <!-- Página anterior -->
                {% if notas_paginadas.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.ver_notas', page=notas_paginadas.prev_num, 
                        ciclo_id=request.args.get('ciclo_id'), 
                        curso_id=request.args.get('curso_id'), 
                        alumno_id=request.args.get('alumno_id')) }}">>
                        <i class="fas fa-chevron-left"></i> Anterior
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link"><i class="fas fa-chevron-left"></i> Anterior</span>
                </li>
                {% endif %}

                <!-- Números de página -->
                {% for page_num in notas_paginadas.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != notas_paginadas.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.ver_notas', page=page_num,
                                ciclo_id=request.args.get('ciclo_id'), 
                                curso_id=request.args.get('curso_id'), 
                                alumno_id=request.args.get('alumno_id')) }}">>
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}

                <!-- Página siguiente -->
                {% if notas_paginadas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.ver_notas', page=notas_paginadas.next_num,
                        ciclo_id=request.args.get('ciclo_id'), 
                        curso_id=request.args.get('curso_id'), 
                        alumno_id=request.args.get('alumno_id')) }}">>
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Siguiente <i class="fas fa-chevron-right"></i></span>
                </li>
                {% endif %}
            </ul>
        </nav>
        
        <!-- Información de paginación -->
        <div class="text-center text-muted mt-2">
            <small>
                Mostrando {{ (notas_paginadas.page - 1) * notas_paginadas.per_page + 1 }} - 
                {{ notas_paginadas.page * notas_paginadas.per_page if notas_paginadas.page * notas_paginadas.per_page <= notas_paginadas.total else notas_paginadas.total }} 
                de {{ notas_paginadas.total }} resultados
            </small>
        </div>
    </div>
</div>
{% endif %}>
                                {{ ciclo.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="curso_id" class="form-label">Curso:</label>
                        <select class="form-select" id="curso_id" name="curso_id">
                            <option value="">-- Todos los cursos --</option>
                            {% for curso in cursos %}
                            <option value="{{ curso.id }}" 
                                    {% if curso_seleccionado and curso.id == curso_seleccionado.id %}selected{% endif %}>
                                {{ curso.nombre }} ({{ curso.codigo }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="alumno_id" class="form-label">Estudiante:</label>
                        <select class="form-select" id="alumno_id" name="alumno_id">
                            <option value="">-- Todos los estudiantes --</option>
                            {% for alumno in alumnos %}
                            <option value="{{ alumno.id }}" 
                                    {% if alumno_seleccionado and alumno.id == alumno_seleccionado.id %}selected{% endif %}>
                                {{ alumno.nombre }} {{ alumno.apellido }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Buscar
                        </button>
                        <a href="{{ url_for('admin.ver_notas') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Limpiar Filtros
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Información de Filtros Aplicados -->
{% if ciclo_seleccionado or curso_seleccionado or alumno_seleccionado %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6 class="alert-heading mb-2">
                <i class="fas fa-info-circle me-2"></i>Filtros Aplicados:
            </h6>
            <div class="d-flex flex-wrap gap-2">
                {% if ciclo_seleccionado %}
                <span class="badge bg-primary">
                    <i class="fas fa-calendar me-1"></i>Ciclo: {{ ciclo_seleccionado.nombre }}
                </span>
                {% endif %}
                {% if curso_seleccionado %}
                <span class="badge bg-warning">
                    <i class="fas fa-book me-1"></i>Curso: {{ curso_seleccionado.nombre }}
                </span>
                {% endif %}
                {% if alumno_seleccionado %}
                <span class="badge bg-success">
                    <i class="fas fa-user me-1"></i>Estudiante: {{ alumno_seleccionado.nombre }} {{ alumno_seleccionado.apellido }}
                </span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Lista de Notas -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Notas Registradas
                    <span class="badge bg-primary ms-2">{{ notas|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if notas %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Curso</th>
                                <th>Estudiante</th>
                                <th>Docente</th>
                                <th>Parciales</th>
                                <th>Nota Final</th>
                                <th>Estado</th>
                                <th>Última Actualización</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for nota, curso, alumno, docente in notas %}
                            <tr>
                                <td>
                                    <div class="curso-info">
                                        <div class="fw-bold">{{ curso.nombre }}</div>
                                        <small class="text-muted">{{ curso.codigo }}</small>
                                        {% if curso.ciclo_academico %}
                                        <br><small class="text-info">{{ curso.ciclo_academico.nombre }}</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                            {{ alumno.nombre[0] }}{{ alumno.apellido[0] }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ alumno.nombre }} {{ alumno.apellido }}</div>
                                            <small class="text-muted">{{ alumno.dni }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="docente-info">
                                        <div class="fw-bold">{{ docente.nombre }} {{ docente.apellido }}</div>
                                        <small class="text-muted">{{ docente.email }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="parciales-info">
                                        {% for i in range(1, 5) %}
                                        {% set parcial = nota|attr('parcial' + i|string) %}
                                        {% if parcial and parcial > 0 %}
                                        <span class="badge bg-light text-dark me-1">
                                            P{{ i }}: {{ parcial }}
                                        </span>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if nota.promedio_final >= 10.5 else 'warning' if nota.promedio_final >= 5 else 'danger' }}">
                                        {{ nota.promedio_final }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if nota.estado == 'publicada' else 'warning' }}">
                                        {{ nota.estado.title() }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ nota.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') if nota.fecha_actualizacion else 'N/A' }}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('admin.ver_notas_curso', curso_id=curso.id) }}" 
                                           class="btn btn-sm btn-outline-info" title="Ver Curso">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('admin.ver_notas_alumno', alumno_id=alumno.id) }}" 
                                           class="btn btn-sm btn-outline-primary" title="Ver Estudiante">
                                            <i class="fas fa-user"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No se encontraron notas</h5>
                    <p class="text-muted">
                        {% if ciclo_seleccionado or curso_seleccionado or alumno_seleccionado %}
                        No hay notas que coincidan con los filtros aplicados.
                        {% else %}
                        No hay notas registradas en el sistema.
                        {% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Paginación -->
{% if notas_paginadas and notas_paginadas.pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Navegación de páginas">
            <ul class="pagination justify-content-center">
                <!-- Página anterior -->
                {% if notas_paginadas.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.ver_notas', page=notas_paginadas.prev_num, 
                        ciclo_id=request.args.get('ciclo_id'), 
                        curso_id=request.args.get('curso_id'), 
                        alumno_id=request.args.get('alumno_id'),
                        estado=request.args.get('estado'),
                        buscar_texto=request.args.get('buscar_texto'),
                        fecha_desde=request.args.get('fecha_desde'),
                        fecha_hasta=request.args.get('fecha_hasta'),
                        promedio_min=request.args.get('promedio_min'),
                        promedio_max=request.args.get('promedio_max')) }}">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link"><i class="fas fa-chevron-left"></i> Anterior</span>
                </li>
                {% endif %}

                <!-- Números de página -->
                {% for page_num in notas_paginadas.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != notas_paginadas.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.ver_notas', page=page_num,
                                ciclo_id=request.args.get('ciclo_id'), 
                                curso_id=request.args.get('curso_id'), 
                                alumno_id=request.args.get('alumno_id'),
                                estado=request.args.get('estado'),
                                buscar_texto=request.args.get('buscar_texto'),
                                fecha_desde=request.args.get('fecha_desde'),
                                fecha_hasta=request.args.get('fecha_hasta'),
                                promedio_min=request.args.get('promedio_min'),
                                promedio_max=request.args.get('promedio_max')) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}

                <!-- Página siguiente -->
                {% if notas_paginadas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.ver_notas', page=notas_paginadas.next_num,
                        ciclo_id=request.args.get('ciclo_id'), 
                        curso_id=request.args.get('curso_id'), 
                        alumno_id=request.args.get('alumno_id'),
                        estado=request.args.get('estado'),
                        buscar_texto=request.args.get('buscar_texto'),
                        fecha_desde=request.args.get('fecha_desde'),
                        fecha_hasta=request.args.get('fecha_hasta'),
                        promedio_min=request.args.get('promedio_min'),
                        promedio_max=request.args.get('promedio_max')) }}">
                        Siguiente <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Siguiente <i class="fas fa-chevron-right"></i></span>
                </li>
                {% endif %}
            </ul>
        </nav>
        
        <!-- Información de paginación -->
        <div class="text-center text-muted mt-2">
            <small>
                Mostrando {{ (notas_paginadas.page - 1) * notas_paginadas.per_page + 1 }} - 
                {{ notas_paginadas.page * notas_paginadas.per_page if notas_paginadas.page * notas_paginadas.per_page <= notas_paginadas.total else notas_paginadas.total }} 
                de {{ notas_paginadas.total }} resultados
            </small>
        </div>
    </div>
</div>
{% endif %}

<style>
    .avatar-sm {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .curso-info .fw-bold {
        font-size: 0.9rem;
    }
    
    .docente-info .fw-bold {
        font-size: 0.9rem;
    }
    
    .parciales-info .badge {
        font-size: 0.75rem;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin-right: 1rem;
    }
    
    .stat-content {
        flex: 1;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .table th {
        border-top: none;
        font-weight: 600;
    }
    
    .badge {
        font-size: 0.75rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cicloSelect = document.getElementById('ciclo_id');
    const cursoSelect = document.getElementById('curso_id');
    const alumnoSelect = document.getElementById('alumno_id');
    
    // Función para actualizar cursos basado en el ciclo seleccionado
    function actualizarCursos() {
        const cicloId = cicloSelect.value;
        
        if (!cicloId) {
            // Si no hay ciclo seleccionado, mostrar todos los cursos
            Array.from(cursoSelect.options).forEach(option => {
                if (option.value !== '') {
                    option.style.display = 'block';
                }
            });
            return;
        }
        
        // Hacer petición AJAX para obtener cursos del ciclo
        fetch(`/admin/api/cursos-por-ciclo/${cicloId}`)
            .then(response => response.json())
            .then(data => {
                // Limpiar opciones actuales (excepto la primera)
                cursoSelect.innerHTML = '<option value="">-- Todos los cursos --</option>';
                
                // Agregar cursos del ciclo seleccionado
                data.cursos.forEach(curso => {
                    const option = document.createElement('option');
                    option.value = curso.id;
                    option.textContent = `${curso.nombre} (${curso.codigo})`;
                    cursoSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar cursos:', error);
            });
    }
    
    // Función para actualizar estudiantes basado en el ciclo seleccionado
    function actualizarEstudiantes() {
        const cicloId = cicloSelect.value;
        
        if (!cicloId) {
            // Si no hay ciclo seleccionado, mostrar todos los estudiantes
            Array.from(alumnoSelect.options).forEach(option => {
                if (option.value !== '') {
                    option.style.display = 'block';
                }
            });
            return;
        }
        
        // Hacer petición AJAX para obtener estudiantes del ciclo
        fetch(`/admin/api/estudiantes-por-ciclo/${cicloId}`)
            .then(response => response.json())
            .then(data => {
                // Limpiar opciones actuales (excepto la primera)
                alumnoSelect.innerHTML = '<option value="">-- Todos los estudiantes --</option>';
                
                // Agregar estudiantes del ciclo seleccionado
                data.estudiantes.forEach(estudiante => {
                    const option = document.createElement('option');
                    option.value = estudiante.id;
                    option.textContent = `${estudiante.nombre} ${estudiante.apellido}`;
                    alumnoSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error al cargar estudiantes:', error);
            });
    }
    
    // Event listener para cambios en el ciclo
    cicloSelect.addEventListener('change', function() {
        actualizarCursos();
        actualizarEstudiantes();
        // Resetear selecciones de curso y estudiante
        cursoSelect.value = '';
        alumnoSelect.value = '';
    });
});
</script>

{% endblock %}
