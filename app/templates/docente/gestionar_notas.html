{% extends "global/base_sistema.html" %}

{% block title %}Gestionar Notas - {{ curso.nombre }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-chart-line me-2"></i>Gestionar Notas: {{ curso.nombre }}
            </h2>
            <a href="{{ url_for('docente.ver_alumnos_curso', curso_id=curso.id) }}" class="btn btn-outline-primary">
                <i class="fas fa-users me-2"></i>Ver Alumnos
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if alumnos_notas %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Alumno</th>
                                <th>DNI</th>
                                <th colspan="8">Actividades (8)</th>
                                <th colspan="4">Prácticas (4)</th>
                                <th colspan="2">Parciales (2)</th>
                                <th>Promedio Final</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                            <tr class="table-secondary">
                                <th></th>
                                <th></th>
                                {% for i in range(1, 9) %}
                                <th>A{{ i }}</th>
                                {% endfor %}
                                {% for i in range(1, 5) %}
                                <th>P{{ i }}</th>
                                {% endfor %}
                                {% for i in range(1, 3) %}
                                <th>Par{{ i }}</th>
                                {% endfor %}
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alumno, nota in alumnos_notas %}
                            <tr>
                                <td>{{ alumno.nombre }} {{ alumno.apellido }}</td>
                                <td>{{ alumno.dni }}</td>
                                
                                <!-- Actividades (8) -->
                                {% for i in range(1, 9) %}
                                <td>
                                    <input type="number" class="form-control form-control-sm"
                                        id="actividad{{ i }}_{{ alumno.id }}"
                                        value="{% if nota and nota.nota_actividades %}{{ nota.nota_actividades['actividad' + i|string] if nota.nota_actividades['actividad' + i|string] else '' }}{% endif %}"
                                        min="0" max="20" step="0.1" placeholder="0-20">
                                </td>
                                {% endfor %}
                                
                                <!-- Prácticas (4) -->
                                {% for i in range(1, 5) %}
                                <td>
                                    <input type="number" class="form-control form-control-sm"
                                        id="practica{{ i }}_{{ alumno.id }}"
                                        value="{% if nota and nota.nota_practicas %}{{ nota.nota_practicas['practica' + i|string] if nota.nota_practicas['practica' + i|string] else '' }}{% endif %}"
                                        min="0" max="20" step="0.1" placeholder="0-20">
                                </td>
                                {% endfor %}
                                
                                <!-- Parciales (2) -->
                                {% for i in range(1, 3) %}
                                <td>
                                    <input type="number" class="form-control form-control-sm"
                                        id="parcial{{ i }}_{{ alumno.id }}"
                                        value="{% if nota and nota.nota_parcial %}{{ nota.nota_parcial['parcial' + i|string] if nota.nota_parcial['parcial' + i|string] else '' }}{% endif %}"
                                        min="0" max="20" step="0.1" placeholder="0-20">
                                </td>
                                {% endfor %}
                                
                                <td>
                                    <span class="badge bg-info" id="promedio_final_{{ alumno.id }}">
                                        {{ "%.1f"|format(nota.promedio_final) if nota and nota.promedio_final else "0.0" }}
                                    </span>
                                </td>
                                <td>
                                    {% if nota and nota.estado == 'publicada' %}
                                    <span class="badge bg-success">Publicada</span>
                                    {% else %}
                                    <span class="badge bg-warning">Borrador</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-primary"
                                            onclick="guardarNotas({{ alumno.id }})" title="Guardar">
                                            <i class="fas fa-save"></i>
                                        </button>
                                        {% if nota %}
                                        <button type="button"
                                            class="btn btn-sm btn-{{ 'success' if nota.estado == 'borrador' else 'warning' }}"
                                            onclick="cambiarEstado({{ alumno.id }}, '{{ nota.estado }}')"
                                            title="{{ 'Publicar' if nota.estado == 'borrador' else 'Pasar a Borrador' }}">
                                            <i class="fas fa-{{ 'eye' if nota.estado == 'borrador' else 'edit' }}"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hay alumnos matriculados</h5>
                    <p class="text-muted">Este curso no tiene alumnos matriculados para gestionar notas.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function guardarNotas(alumnoId) {
        const formData = new FormData();
        const todasLasNotas = [];

        // Recopilar actividades (8)
        for (let i = 1; i <= 8; i++) {
            const elemento = document.getElementById('actividad' + i + '_' + alumnoId);
            const valor = elemento ? elemento.value : '';
            todasLasNotas.push(valor);
            formData.append('actividad' + i, valor);
        }

        // Recopilar prácticas (4)
        for (let i = 1; i <= 4; i++) {
            const elemento = document.getElementById('practica' + i + '_' + alumnoId);
            const valor = elemento ? elemento.value : '';
            todasLasNotas.push(valor);
            formData.append('practica' + i, valor);
        }

        // Recopilar parciales (2)
        for (let i = 1; i <= 2; i++) {
            const elemento = document.getElementById('parcial' + i + '_' + alumnoId);
            const valor = elemento ? elemento.value : '';
            todasLasNotas.push(valor);
            formData.append('parcial' + i, valor);
        }

        // Validar que al menos una nota tenga valor
        const tieneNotas = todasLasNotas.some(nota => nota && nota.trim() !== '');
        if (!tieneNotas) {
            mostrarAlerta('Debe ingresar al menos una nota.', 'warning');
            return;
        }

        // Validar rango de notas
        for (let i = 0; i < todasLasNotas.length; i++) {
            if (todasLasNotas[i] && (parseFloat(todasLasNotas[i]) < 0 || parseFloat(todasLasNotas[i]) > 20)) {
                mostrarAlerta('Las notas deben estar entre 0 y 20.', 'warning');
                return;
            }
        }

        formData.append('alumno_id', alumnoId);
        formData.append('estado', 'borrador'); // Por defecto en borrador

        // Mostrar indicador de carga
        const boton = document.querySelector(`button[onclick="guardarNotas(${alumnoId})"]`);
        const iconoOriginal = boton.innerHTML;
        boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        boton.disabled = true;

        fetch('{{ url_for("docente.guardar_notas", curso_id=curso.id) }}', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Actualizar promedio final
                    document.getElementById('promedio_final_' + alumnoId).textContent = data.promedio_final.toFixed(1);

                    // Actualizar estado si existe
                    const estadoElement = document.querySelector(`span[id*="estado_${alumnoId}"]`);
                    if (estadoElement) {
                        estadoElement.textContent = data.estado === 'publicada' ? 'Publicada' : 'Borrador';
                        estadoElement.className = data.estado === 'publicada' ? 'badge bg-success' : 'badge bg-warning';
                    }

                    mostrarAlerta(data.message, 'success');
                } else {
                    mostrarAlerta('Error: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al guardar las notas: ' + error.message, 'danger');
            })
            .finally(() => {
                // Restaurar botón
                boton.innerHTML = iconoOriginal;
                boton.disabled = false;
            });
    }

    function cambiarEstado(alumnoId, estadoActual) {
        const nuevoEstado = estadoActual === 'borrador' ? 'publicada' : 'borrador';
        const confirmacion = confirm(`¿Está seguro de cambiar el estado a ${nuevoEstado}?`);

        if (!confirmacion) return;

        fetch('{{ url_for("docente.cambiar_estado_nota", curso_id=curso.id, alumno_id=0) }}'.replace('0', alumnoId), {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar estado en la interfaz
                    const estadoElement = document.querySelector(`span[id*="estado_${alumnoId}"]`);
                    if (estadoElement) {
                        estadoElement.textContent = data.estado === 'publicada' ? 'Publicada' : 'Borrador';
                        estadoElement.className = data.estado === 'publicada' ? 'badge bg-success' : 'badge bg-warning';
                    }

                    // Actualizar botón de cambio de estado
                    const botonEstado = document.querySelector(`button[onclick*="cambiarEstado(${alumnoId}"]`);
                    if (botonEstado) {
                        botonEstado.className = data.estado === 'borrador' ? 'btn btn-sm btn-success' : 'btn btn-sm btn-warning';
                        botonEstado.title = data.estado === 'borrador' ? 'Publicar' : 'Pasar a Borrador';
                        botonEstado.innerHTML = `<i class="fas fa-${data.estado === 'borrador' ? 'eye' : 'edit'}"></i>`;
                    }

                    mostrarAlerta(data.message, 'success');
                } else {
                    mostrarAlerta('Error: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarAlerta('Error al cambiar el estado: ' + error.message, 'danger');
            });
    }

    function mostrarAlerta(mensaje, tipo) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${tipo} alert-dismissible fade show`;
        alert.style.position = 'relative';
        alert.style.zIndex = '1055';
        alert.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        const container = document.querySelector('.container-fluid');
        if (container) {
            container.insertBefore(alert, container.firstChild);
        }

        // Auto-ocultar después de 5 segundos
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    // Calcular nota final automáticamente
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll('input[type="number"]');
        const numeroParciales = {{ curso.numero_parciales }};

        inputs.forEach(input => {
        input.addEventListener('input', function () {
            const alumnoId = this.id.split('_')[1];
            const notas = [];

            // Recopilar todas las notas del alumno
            for (let i = 1; i <= numeroParciales; i++) {
                const elemento = document.getElementById('parcial' + i + '_' + alumnoId);
                const valor = elemento ? parseFloat(elemento.value) || 0 : 0;
                if (valor > 0) notas.push(valor);
            }

            // Calcular promedio
            let notaFinal = 0;
            if (notas.length > 0) {
                const suma = notas.reduce((a, b) => a + b, 0);
                notaFinal = suma / notas.length;
            }

            document.getElementById('nota_final_' + alumnoId).textContent = notaFinal.toFixed(1);
        });
    });
    });
</script>
{% endblock %}